#summary Discover Java PaaS Cloud with CloudBees

<wiki:toc max_depth="2" />

<br/>
----
<br/>

= Goal of the lab =

 * The purpose of this workshop is to use Cloudbees platform. Cloudbees is both a development platform and a production platform.
 
 * Our goal is to make some changes to the famous petclinic application then deploy it on cloudbees production cluster.

<p align="center">
<img src="http://xebia-france.googlecode.com/svn/wiki/cloudbees-img/workshop_overview.png" height="450" />
</p>

= Workshop requirements =

 * Git client: !GitHub has [http://help.github.com/set-up-git-redirect setup tutorials] for all platforms (just perform the "Download and Install Git" step, we'll set up the SSH key at the beginning of the lab).
 
 * [http://maven.apache.org Apache Maven] (version 2.2.1 or above).
 
 * SSH client (should already be installed on any Unix platform, will come with Git for Windows).
 
 * SSH private key (sent by email before the lab).

<br/>
----
<br/>

= Workshop Steps =

== @DEV ==

=== Configure GIT repository ===

 * Backup your existing {{{/.ssh}}} folder and install your following [id_rsa https://s3-eu-west-1.amazonaws.com/xebia-cloudbees-workshop/id_rsa] SSH private key:
{{{
$ mv ~/.ssh ~/.ssh.bak
$ mkdir ~/.ssh
$ curl https://s3-eu-west-1.amazonaws.com/xebia-cloudbees-workshop/id_rsa --output ~/.ssh/id_rsa
$ chmod 700 ~/.ssh
$ chmod -R 600 ~/.ssh/*
}}}

 * Unzip the [https://s3-eu-west-1.amazonaws.com/xebia-cloudbees-workshop/petclinic.zip petclinic.zip] application under {{{~/petclinic}}}.
{{{
$ mkdir ~/petclinic/
$ curl https://s3-eu-west-1.amazonaws.com/xebia-cloudbees-workshop/petclinic.zip --output ~/petclinic/petclinic.zip
$ cd ~/petclinic/
$ unzip petclinic.zip
}}}
 * Modify the *groupId* in the Maven POM file (replace 'XX' by your team number, e.g. '01'):
{{{
<groupId>fr.xebia.techevent.labXX</groupId>
}}}

 * Initialize a new Git local repository:
{{{
$ cd ~/petclinic
$ git init
$ git remote add origin ssh://git@git.cloudbees.com/atelier-xebia/labXX.git
$ git add -A  # if you want to check everything in
$ git commit -m 'Initial checkin'
$ git push origin master
}}}

 * Create an integration branch named "develop":

{{{
$ git branch develop
$ git checkout develop
$ git push origin develop
}}}

 * Verify your branch organization by using the command "git-branch", and check if everything is correct:

{{{
$ git branch -a
  * develop
  master
  remotes/origin/develop
  remotes/origin/master
}}}

 * To avoid having to specify the 'master' branch for future pushes, you can add the following at the end of your *.git/config* file:

{{{
[branch "master"]
  remote = origin
  merge = refs/head/master
}}}

=== Create a Jenkins job for Continuous Integration ===

 * Log in to !CloudBees (_your credentials will be provided at the beginning of the lab_).
 
 * Click on the *Jenkins build* icon.
 
 * Go to the folder with your group name *"labXX"*.
 
 * Create a new item from the left menu with the job name *"1-labXX-DEV"* and tick "Build a Maven2/3 project".

<p align="center">
<img src="http://xebia-france.googlecode.com/svn/wiki/cloudbees-img/add-jenkins-job.png" height="400" />
</p>
 
 ** On the *"Code source management"* part choose *"Git"* and fill these parameters:

{{{
URL of repository=ssh://git@git.cloudbees.com/atelier-xebia/labXX.git
Branch Specifier (blank for default)=develop
}}}
 
 ** On the *"Build triggers"* part, tick *"poll SCM"* and provide this CRON expression (which means "every minute"):

{{{
* * * * *
}}}
 
 ** On the *"Build"* part indicate the Maven goal:

{{{
clean package
}}}
 
 ** On the *"Post build action"* part, tick *"Deploy artifacts to my Private !CloudBees Repository"* option and verify that SNAPSHOT repository is correctly selected. Also tick *Sonar* option to active sonar analyze of your project.
 
 ** Save the configuration and run the job (it can take some minutes before the build begins).
 
 ** The build will be unstable due to a test failure:

<p align="center">
<img src="http://xebia-france.googlecode.com/svn/wiki/cloudbees-img/ci-job-failed.png" height="350" />
</p>

=== Fix the build and check the Continuous Integration ===

 ** Open the *!OwnerTests* class and fix the test failure.

{{{
fido.setName("Rex"); // should be "Fido"!
}}}

 ** Push your modification on the remote repository:

{{{
$ git commit -am "Fix the test failure ;-)"
$ git push
}}}

 ** The Continuous Integration job should be run automatically.

<p align="center">
<img src="http://xebia-france.googlecode.com/svn/wiki/cloudbees-img/ci-job-fixed.png" height="350" />
</p>

 ** Once the build is fixed, go back to the job page. Click on the *Sonar* link to have a look at your quality metrics.

<br/>
----
<br/>

== @INTEG ==

=== Configure a new MySQL database ===
 
 * Create and configure a new MySQL database by clicking on the databases icon in the home page of the Cloudbees account. Then click on the add new database link. Fill with the following parameters :

{{{
Database name: labXX-dev
Username: labXX-dev
Password: labXX
}}}

<p align="center">
<img src="http://xebia-france.googlecode.com/svn/wiki/cloudbees-img/create-database-mysql-dev.png" height="350" />
</p>

=== Configure a new application ===

 * Go back to the Home page in !CloudBees and click on *Applications*

 * Create and configure a new application on *RUN@cloud* called "xebia-atelier/labXX-integ"

<p align="center">
<img src="http://xebia-france.googlecode.com/svn/wiki/cloudbees-img/create-app-integ.png" height="300" />
</p>
 
=== Create a Jenkins job for deploying application on Integration environment ===

 * Create a new Job from the left menu with the job name *"2-labXX-INTEG"* and tick "Build a Maven2/3 project"
 
 * On the "Code source management" part choose "Git" and fill these parameters:

{{{
URL of repository=ssh://git@git.cloudbees.com/atelier-xebia/labXX.git
Branch Specifier (blank for default)=develop
}}}

 * On the *"Build triggers"* part, tick *"Build after other projects are built"* and indicate your Continuous Integration job

{{{
Project names: 1-labXX-DEV
}}}

 * On the "Build" part indicate the Maven goal

{{{
clean package
}}}

 * On the "Post build action" part tick *"Deploy to !CloudBees"* option and fill parameters:

{{{
Application Id=atelier-xebia/labXX-integ
}}}

<p align="center">
<img src="http://xebia-france.googlecode.com/svn/wiki/cloudbees-img/configure-deploy-jenkins-job.png" height="300" />
</p>

=== Configure your application for Integration environment ===

 * The sources provided for the lab are already configured for MySQL. The only thing you need to do is adapt your database info. Go to the *src/main/resources/environment/dev/* directory and edit the *cloudbees.properties* file according to your team number (this file is used to filter *src/main/webapp/WEB-INF/cloudbees-web.xml* during the build):

{{{
cloudbees.datasource.username=labXX-dev
cloudbees.datasource.password=labXX
cloudbees.datasource.url=jdbc:cloudbees://labXX-dev
}}}

 * Commit and push your changes:

{{{
$ git commit -am "Configure integration database"
$ git push
}}}

 * The Continuous Integration job should be run automatically. Then, the new Integration job should be executed.
 
 * One the job finished, you can access to your application through this URL:

{{{
http://labXX-integ.atelier-xebia.cloudbees.net
}}}

<br/>
----
<br/>

== @TEST ==

=== Run Selenium tests from the cloud ===

 * Update your pom.xml with this selenium profile. Replace the property _selenium.target.host_ with the home page of the you want to launch Selenium tests against. (ex: your integration environment for instance)

{{{
<profile>
	<id>selenium</id>
	<build>
	<plugins>
	  <plugin>
		<groupId>org.apache.maven.plugins</groupId>
		<artifactId>maven-failsafe-plugin</artifactId>
		<version>2.10</version>
		<executions>
			<execution>
				<id>selenium-verify</id>
				<phase>verify</phase>
				<goals>
					<goal>integration-test</goal>
					<goal>verify</goal>
				</goals>
			</execution>
		</executions>
		<configuration>
		  <includes>
			<include>**/*Selenium.java</include>
		  </includes>
		  <systemProperties>
			  <selenium.target.host>(REPLACE WITH YOUR INTEGRATION HOME PAGE URL)</selenium.target.host>
			  <saucelabs.account.url>http://atelier-xebia:ab03b6f6-14b8-4458-b7c7-cc306ba0b8c0@ondemand.saucelabs.com:80/wd/hub</saucelabs.account.url>
		  </systemProperties>
		</configuration>
	  </plugin>
	</plugins>
	</build>
</profile>
}}}
 
 * Update your pom.xml with this dependency

{{{
<dependency>
	<groupId>org.seleniumhq.selenium</groupId>
	<artifactId>selenium-java</artifactId>
	<version>2.0rc3</version>
</dependency>
}}}
 
 * Create a new package _selenium_ in _src/test/java/org/springframework/samples/petclinic/_ and add the 2 following java classes.

{{{
package org.springframework.samples.petclinic.selenium;

import java.net.URL;
import java.util.concurrent.TimeUnit;

import junit.framework.TestCase;

import org.openqa.selenium.Platform;
import org.openqa.selenium.WebDriver;
import org.openqa.selenium.remote.DesiredCapabilities;
import org.openqa.selenium.remote.RemoteWebDriver;

public class SeleniumSauceLabSetUp extends TestCase {
    
	protected WebDriver driver;
	protected String targetUrl;
	
	public void setUp() throws Exception {
        DesiredCapabilities capabillities = DesiredCapabilities.firefox();
        capabillities.setCapability("version", "5");
        capabillities.setCapability("platform", Platform.XP);
        capabillities.setCapability("name", "Simple selenium test [" + System.currentTimeMillis() + "].");

        this.driver = new RemoteWebDriver(new URL(System.getProperty("saucelabs.account.url")), capabillities);
        this.targetUrl = System.getProperty("selenium.target.host");
        driver.manage().timeouts().implicitlyWait(30, TimeUnit.SECONDS);
        
        System.out.println("Running selenium tests against: " + targetUrl);
    }

    public void tearDown() throws Exception {
        this.driver.quit();
    }
}
}}}
 
 * The actual test class
 
{{{
package org.springframework.samples.petclinic.selenium;

public class HomePageSelenium extends SeleniumSauceLabSetUp {

    public void test_home_page_should_have_correct_title() throws Exception {
	    driver.get(targetUrl);
	    assertEquals("PetClinic :: a Spring Framework demonstration", driver.getTitle());
	}
}
}}}
 
 * Run locally the following command to launch your Selenium tests against the target url

{{{
mvn clean verify -Pselenium
}}}
 
 * Or if you want to override the target url for Selenium

{{{
mvn clean verify -Pselenium -Dselenium.target.host={HOME_PAGE_OF_YOUR_CHOICE}
}}}

 * You can see your test was logged at https://saucelabs.com/jobs

=== Configure a new job for Selenium tests ===

 * Create a new Job from the left menu with the job name *"3-labXX-TEST"* and tick "Build a Maven2/3 project"

 * On the *"Build triggers"* part, tick *"Build after other projects are built"* and indicate your Integration deployment job

{{{
Project names: 2-labXX-INTEG
}}}

*TODO*
 
<br/>
----
<br/>

== @RUN ==

=== Configure a new MySQL database ===

 * Go back to the Home page in !CloudBees and click on *Applications*
 
 * Create and configure a new MySQL database by clicking on the databases icon in the home page of the Cloudbees account. Then click on the add new database link. Fill with the following parameters :

{{{
Database name: labXX
Username: labXX
Password: labXX
}}}

<p align="center">
<img src="http://xebia-france.googlecode.com/svn/wiki/cloudbees-img/create-database-mysql.png" height="350" />
</p>

=== Configure a new application with Elasticity, monitoring with New Relic and logs with Papertrail ===

 * Go back to the Home page in !CloudBees and click on *Applications*

 * Create and configure a new application on *RUN@cloud* called "xebia-atelier/labXX"

 * Click on the "configure" link under your application.

 * On the "Redundancy and Scale", choose "Multiple Instances" option.

 * Tick "Enable New Relic RPM application monitoring" and "Enable Papertrail application logging"

=== Configure your application for Production environment ===

 * The sources provided for the lab are already configured for MySQL. The only thing you need to do is adapt your database info. Edit *src/main/resources/environment/prod/cloudbees-web.properties* (this file is used to filter *src/main/webapp/WEB-INF/cloudbees-web.xml* during the build):

{{{
cloudbees.datasource.username=labXX
cloudbees.datasource.password=labXX
cloudbees.datasource.url=jdbc:cloudbees://labXX
}}}

 * Commit and push your changes:

{{{
$ git commit -am "Configure production database"
$ git push
}}}

=== Create a Jenkins job for deploying application on Production environment ===

 * Create a new Job from the left menu with the job name *"4-labXX-RUN"* and tick "Build a Maven2/3 project"

 * On the "Code source management" part choose "Git" and fill these parameters:

{{{
URL of repository=ssh://git@git.cloudbees.com/atelier-xebia/labXX.git
Branch Specifier (blank for default)=master
}}}

 * On the "Build" part indicate the Maven goal

{{{
clean package -Denvironment=prod
}}}

 * On the "Post build action" part tick *"Deploy to !CloudBees"* option and fill parameters. If the application Id doesn't exist, it will be created.

{{{
Application Id=atelier-xebia/labXX
}}}

 * Save the configuration.
 
=== Branch promotion with Git ===
 
 * Merge your *"develop"* branch to your *"master"* branch:
 
{{{
$ git checkout master
$ git merge develop --no-ff
$ git push
}}}

 * The Production deployment job should be run automatically.
 
 * One the job finished, you can access to your application through this URL:

{{{
http://labXX.atelier-xebia.cloudbees.net
}}}

 * Go back to the !CloudBees home page and click on the *Applications* icon. Locate your instance in the list and click on it. The management page provides useful information like usage statistics, access to the production logs, and incidentally the URL of your application :-) Click on it to check that it functions properly.

<br/>
----
<br/>

== @PERF ==

=== Stress test with JMeter === 

 * Edit pom.xml

 * Add performance profile to run [https://github.com/Ronnie76er/jmeter-maven-plugin/wiki jmeter-maven-plugin]

{{{
<profile>
  <id>performance</id>
  <activation>
    <activeByDefault>false</activeByDefault>
  </activation>
  <properties>
    <hostAddress>test-eb.atelier-xebia.cloudbees.net</hostAddress>
    <hostPort>80</hostPort>
    <nbVirtualUsers>5</nbVirtualUsers>
    <nbLoopsCount>2</nbLoopsCount>
    <nbRampUp>5</nbRampUp>
  </properties>
  <repositories>
    <repository>
      <id>jmeter-maven-plugin</id>
      <name>Maven JMeter Plugin</name>
      <url>http://yciabaud.github.com/jmeter-maven-plugin/repository</url>
    </repository>
  </repositories>

  <pluginRepositories>
    <pluginRepository>
      <id>jmeter-maven-plugin</id>
      <name>Maven JMeter Plugin</name>
      <url>http://yciabaud.github.com/jmeter-maven-plugin/repository</url>
    </pluginRepository>
  </pluginRepositories>

  <build>
    <plugins>
      <plugin>
        <groupId>org.apache.jmeter</groupId>
        <artifactId>maven-jmeter-plugin</artifactId>
        <version>1.2</version>
        <executions>
          <execution>
            <id>jmeter-tests</id>
            <phase>integration-test</phase>
            <goals>
              <goal>jmeter</goal>
            </goals>
          </execution>
        </executions>
        <configuration>
          <reportDir>
            ${project.build.directory}/jmeter-reports
          </reportDir>
          <jmeterUserProperties>
            <hostAddress>${hostAddress}</hostAddress>
            <hostPort>${hostPort}</hostPort>
            <nbVirtualUsers>${nbVirtualUsers}</nbVirtualUsers>
            <nbLoopsCount>${nbLoopsCount}</nbLoopsCount>
            <nbRampUp>${nbRampUp}</nbRampUp>
          </jmeterUserProperties>
        </configuration>
      </plugin>
    </plugins>
  </build>
</profile>
}}}

 * Create folder src/test/jmeter and put [http://xebia-france.googlecode.com/svn/wiki/cloudbees-img/petclinic-cloudbees.jmx petclinic-cloudbees.jmx]

 * Create a new Job from the left menu with the job name *"5-labXX-PERF"* and tick "Build a Maven2/3 project"

 * Add the following Maven goals and replace "XX" by your group number:

{{{
clean integration-test -Pperformance -DhostAddress=labXX.atelier-xebia.cloudbees.net -DhostPort=80 -DnbVirtualUsers=600 -DnbLoopsCount=2 -DnbRampUp=60
}}}

 * Configure Post-build Actions and check Publish Performance test result report

<p align="center">
<img src="http://xebia-france.googlecode.com/svn/wiki/cloudbees-img/configure-performance-test-job-jenkins.png" height="200" />
</p>
 
 * Report page on jenkins can be view by clicking on Performance Trend 

<p align="center">
<img src="http://xebia-france.googlecode.com/svn/wiki/cloudbees-img/performance-jenkins-jmeter.png" height="250" />
</p>

<p align="center">
<img src="http://xebia-france.googlecode.com/svn/wiki/cloudbees-img/performance-jenkins-jmeter-trend.png" height="300" />
</p>
 
=== Monitoring with New Relic ===

 * Click on the services link in the top bar.

 * Click on the "New Relic" icon. You can read a brief [http://wiki.cloudbees.com/bin/view/RUN/NewRelic presentation] in the wiki. 

 * Verify elasticity by checking how many servers are running

<p align="center">
<img src="http://xebia-france.googlecode.com/svn/wiki/cloudbees-img/newrelic-performance.png" height="600" />
</p>
 
<br/>
----
<br/>

== @SDK ==
The SDK provides command-line tools to manage applications and databases.

=== Installing the SDK ===
On your !CloudBees home page, click on the *!CloudBees SDK* link in the *Downloads* section. Follow the installation instructions for your platform.

=== Getting information ==
List the applications available to the workshop's account:
{{{
$ bees app:list
}}}

You should see your production application (as well as those of the other teams):
{{{
Application                Status    URL                                    Instance(s)
...
atelier-xebia/labXX-prod   active    labXX-prod.atelier-xebia.cloudbees.net 1
}}}

To get more information, try the following command:
{{{
$ bees app:info -a atelier-xebia/labXX-prod
}}}


=== Tailing the logs ===
Should you get nostalgic of the good old Unix *tail* command, the SDK provides a way to follow your logs in real-time from the command line:
{{{
$ bees app:tail -a atelier-xebia/labXX-prod
}}}

Go back to the application in your browser and navigate through a few pages; the console logs should get updated.


=== Creating and deploying a new application ===
In this section, we'll bootstrap an application from a !CloudBees-provided template, and deploy it to the cloud from the command-line.

 * Run the following command (the new application's root directory will be created in the current directory):
{{{
$ cd ~/my_projects
$ bees create -a atelier-xebia/helloworldXX -p fr.xebia helloworldXX
}}}

 * Navigate to the newly created directory and examine the application structure. Edit *webapp/index.jsp* and locate for this text:
{{{
<h2 class="color text-xl">This application under development</h2>
}}}

 * Replace it with something more personal:
{{{
<h2 class="color text-xl">Team XX says: hello, world!</h2>
}}}

 * Launch your application locally by running this command from your root directory (NB: if port 8080 is already used on your machine, specify another with the *-p* option):
{{{
$ bees run
}}}

 * Navigate to http://localhost:8080 to view the home page with your personal message.

 * Now let's deploy the application to the cloud! Kill your local server and run the following command (again from the application's root directory):
{{{
$ bees deploy -a atelier-xebia/helloworldXX
}}}

 * In the !CloudBees web administration console, go to the applications management page. Your new app should be available.