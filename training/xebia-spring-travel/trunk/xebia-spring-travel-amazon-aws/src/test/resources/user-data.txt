Content-Type: multipart/mixed; boundary="===============3368047838066160523=="
MIME-Version: 1.0

--===============3368047838066160523==
Content-Type: text/x-shellscript; charset="us-ascii"
MIME-Version: 1.0
Content-Transfer-Encoding: 7bit
Content-Disposition: attachment; filename="provision_tomcat.py"

#!/usr/bin/env python
from urllib import urlretrieve, URLopener
from io import open
import shutil
from time import gmtime, strftime

catalinaBase = '/opt/apache-tomcat'

# BACKUP catalina.properties
src = catalinaBase + '/conf/catalina.properties'
dst = catalinaBase + '/conf/catalina-' + strftime('%Y%m%d-%H%M%S', gmtime()) + '.properties'
shutil.copy(src, dst)

print('Created backup ' + dst)

properties = {'jdbc.url':'jdbc:mysql://myhost:3306/mydb', 'jdbc.username':'root', 'jdbc.password':'root'}

f = open(src, 'ab')

f.write('\n\n')
f.write('# BEGIN OF MODIFIED BY CLOUD-INIT ' + strftime('%Y/%m/%d-%H:%M:%S', gmtime()) + '#\n')
f.write('\n')

for key, value in sorted(properties.iteritems()):
    f.write(key + '=' + value + '\n')
    
f.write('\n')
f.write('# END OF MODIFIED BY CLOUD-INIT #\n')
f.write('\n')
f.close()

print('Updated ' + src)

# DOWNLOAD WAR
proxies = {}
url = 'http://mirrors.ibiblio.org/pub/mirrors/maven2/org/eclipse/jetty/tests/test-webapp-rfc2616/7.0.2.RC0/test-webapp-rfc2616-7.0.2.RC0.war'
filename = catalinaBase + '/webapps/test-webapp-rfc2616-7.0.2.RC0.war'
URLopener(proxies).retrieve(url, filename)

print('Downloaded ' + filename)
--===============3368047838066160523==--